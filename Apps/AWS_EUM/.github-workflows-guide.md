# GitHub Actions Workflows Guide

This document explains how to use the automated Git Flow workflows for AWS EUM v3.

## Overview

Three automated workflows are configured:

1. **Docker Build & Push** - Builds and publishes Docker images
2. **Version Bump & Release** - Automates version management
3. **Pull Request Checks** - Validates code quality

## Workflow 1: Docker Build & Push

### When It Runs

**Automatically:**
- Push to `main` branch ‚Üí builds `latest` tag
- Push to `develop` branch ‚Üí builds `develop` tag
- Create Git tag (e.g., `v3.0.7`) ‚Üí builds version-specific tags
- Pull request ‚Üí builds test image (doesn't push)

**Manually:**
- Go to **Actions** tab ‚Üí **Build and Push AWS EUM v3 Docker Image** ‚Üí **Run workflow**

### What It Does

1. Detects version from `package.json`
2. Builds multi-architecture images (amd64, arm64)
3. Pushes to GitHub Container Registry
4. Creates multiple tags:
   - `ghcr.io/n85uk/aws-eum:latest` (main branch only)
   - `ghcr.io/n85uk/aws-eum:develop` (develop branch)
   - `ghcr.io/n85uk/aws-eum:3.0.7` (version tag)
   - `ghcr.io/n85uk/aws-eum:v3` (major version)
5. Runs syntax tests on built image

### How to Use

#### Automatic Build on Commit

```bash
# Make changes
git add Apps/AWS_EUM/server.js
git commit -m "feat: add new feature"
git push origin main

# GitHub Actions automatically builds and pushes
# Check Actions tab for progress
```

#### Manual Build

1. Go to: https://github.com/N85UK/UNRAID_Apps/actions
2. Click: **Build and Push AWS EUM v3 Docker Image**
3. Click: **Run workflow**
4. Select branch and optional custom tag
5. Click: **Run workflow** button

### Viewing Build Results

After the workflow completes:
- Check the **Summary** for image tags
- View **Docker Image Built Successfully** section
- Copy the pull command for your version

Example output:
```bash
docker pull ghcr.io/n85uk/aws-eum:3.0.7
```

## Workflow 2: Version Bump & Release

### When to Use

When you're ready to release a new version with proper semantic versioning.

### How to Use

1. **Go to Actions:**
   - Navigate to: https://github.com/N85UK/UNRAID_Apps/actions
   - Click: **Version Bump and Release**

2. **Run Workflow:**
   - Click: **Run workflow**
   - Select **branch:** `main`
   - Select **bump-type:**
     - `patch` ‚Üí 3.0.7 ‚Üí 3.0.8 (bug fixes)
     - `minor` ‚Üí 3.0.7 ‚Üí 3.1.0 (new features)
     - `major` ‚Üí 3.0.7 ‚Üí 4.0.0 (breaking changes)
   - Select **app:** `AWS_EUM`
   - Click: **Run workflow** button

3. **What Happens:**
   - ‚úÖ Updates `package.json` version
   - ‚úÖ Updates `server.js` APP_VERSION
   - ‚úÖ Updates `Dockerfile` version
   - ‚úÖ Creates/updates `CHANGELOG.md` entry
   - ‚úÖ Commits changes with conventional message
   - ‚úÖ Creates Git tag (e.g., `v3.0.8`)
   - ‚úÖ Pushes to repository
   - ‚úÖ Creates GitHub Release
   - ‚úÖ Triggers Docker build automatically

### Semantic Versioning Guide

**Patch (3.0.7 ‚Üí 3.0.8):**
- Bug fixes
- Security patches
- Documentation updates
- No new features

**Minor (3.0.7 ‚Üí 3.1.0):**
- New features
- Backwards compatible
- Enhancements
- Deprecations

**Major (3.0.7 ‚Üí 4.0.0):**
- Breaking changes
- API changes
- Major refactors
- Non-backwards compatible

## Workflow 3: Pull Request Checks

### When It Runs

Automatically on every Pull Request to `main` or `develop` branches.

### What It Checks

1. **Syntax Validation**
   - Runs `node -c server.js`
   - Ensures code has no syntax errors

2. **Version Consistency**
   - Checks `package.json` version
   - Checks `server.js` APP_VERSION
   - Checks `Dockerfile` version
   - Fails if they don't match

3. **Required Files**
   - Verifies all critical files exist:
     - server.js
     - package.json
     - Dockerfile
     - views/index-v3.ejs
     - public/css/style-v3.css
     - public/js/app-v3.js

4. **Docker Build Test**
   - Attempts to build Docker image
   - Ensures Dockerfile is valid

### How to Use

1. **Create Feature Branch:**
   ```bash
   git checkout develop
   git pull origin develop
   git checkout -b feature/my-feature
   ```

2. **Make Changes:**
   ```bash
   # Edit files
   git add .
   git commit -m "feat: add my feature"
   git push origin feature/my-feature
   ```

3. **Create Pull Request:**
   - Go to GitHub repository
   - Click "Pull requests" ‚Üí "New pull request"
   - Base: `develop` ‚Üê Compare: `feature/my-feature`
   - Fill out PR template
   - Click "Create pull request"

4. **Automated Checks Run:**
   - Watch the **Checks** tab
   - All checks must pass before merging
   - Fix any issues and push again

5. **Merge:**
   - Once checks pass and approved
   - Click "Merge pull request"
   - Choose "Squash and merge" for clean history

## Git Flow Branching Strategy

### Branch Types

```
main (production)
  ‚Üë
  ‚îî‚îÄ‚îÄ release/3.1.0 (release prep)
        ‚Üë
develop (integration)
  ‚Üë
  ‚îú‚îÄ‚îÄ feature/add-mfa (new features)
  ‚îú‚îÄ‚îÄ bugfix/fix-charts (bug fixes)
  ‚îî‚îÄ‚îÄ hotfix/security (urgent fixes)
```

### Typical Workflow

#### 1. New Feature

```bash
# Start from develop
git checkout develop
git pull origin develop
git checkout -b feature/add-sms-templates

# Make changes
git add .
git commit -m "feat: add SMS templates"
git push origin feature/add-sms-templates

# Create PR: feature/add-sms-templates ‚Üí develop
# After approval and checks pass, merge to develop
```

#### 2. Bug Fix

```bash
# Non-critical bug
git checkout develop
git checkout -b bugfix/fix-rate-limiting

# Make changes
git commit -m "fix: correct rate limiting calculation"
git push origin bugfix/fix-rate-limiting

# Create PR: bugfix/fix-rate-limiting ‚Üí develop
```

#### 3. Hotfix (Critical Production Bug)

```bash
# Critical bug in production
git checkout main
git pull origin main
git checkout -b hotfix/security-patch

# Fix the issue
git commit -m "fix(security): patch XSS vulnerability"
git push origin hotfix/security-patch

# Create PR: hotfix/security-patch ‚Üí main
# After merge, also merge to develop
```

#### 4. Release

```bash
# Prepare release from develop
git checkout develop
git pull origin develop
git checkout -b release/3.1.0

# Final testing and version updates
# Use "Version Bump and Release" workflow
# Or manually update versions

# Merge to main
git checkout main
git merge release/3.1.0
git tag v3.1.0
git push origin main v3.1.0

# Merge back to develop
git checkout develop
git merge release/3.1.0
git push origin develop
```

## Environment Setup

### GitHub Secrets

No additional secrets needed! The workflows use `GITHUB_TOKEN` which is automatically provided.

### Permissions

The repository needs these permissions enabled:
- ‚úÖ Read and write permissions (Settings ‚Üí Actions ‚Üí General ‚Üí Workflow permissions)
- ‚úÖ Allow GitHub Actions to create and approve pull requests

### Container Registry

Images are pushed to: **GitHub Container Registry (ghcr.io)**

Make the images public:
1. Go to: https://github.com/N85UK?tab=packages
2. Find: `aws-eum`
3. Click: Package settings
4. Change visibility: Public

## Quick Reference

### Pull Latest Image

```bash
# Latest stable release (main branch)
docker pull ghcr.io/n85uk/aws-eum:latest

# Development version
docker pull ghcr.io/n85uk/aws-eum:develop

# Specific version
docker pull ghcr.io/n85uk/aws-eum:3.0.7

# Major version (auto-updates to latest 3.x.x)
docker pull ghcr.io/n85uk/aws-eum:v3
```

### Check Workflow Status

```bash
# View all workflows
https://github.com/N85UK/UNRAID_Apps/actions

# View specific workflow runs
gh run list --workflow=docker-build-aws-eum.yml

# View logs
gh run view <run-id> --log
```

### Commit Message Format

```
<type>(<scope>): <subject>

feat(api): add SMS template support
fix(ui): resolve chart rendering issue
docs(readme): update installation steps
chore(deps): upgrade dependencies
```

## Troubleshooting

### Build Fails

**Check:**
- Syntax errors: `node -c server.js`
- Version consistency across files
- Docker builds locally: `docker build -t test .`
- All required files exist

### Version Mismatch Error

**Fix:**
Ensure these match:
```javascript
// package.json
"version": "3.0.7"

// server.js
const APP_VERSION = '3.0.7';

// Dockerfile
version="3.0.7"
```

Use the **Version Bump and Release** workflow to keep them in sync automatically.

### Image Not Updating

**Solutions:**
1. Check workflow ran successfully in Actions tab
2. Wait 2-3 minutes for image to be available
3. Pull with `--no-cache` flag: `docker pull --no-cache ghcr.io/n85uk/aws-eum:latest`
4. Check image was made public in GitHub Packages

## Best Practices

1. **Always work on feature branches** - Never commit directly to `main` or `develop`
2. **Use conventional commits** - Makes changelog generation automatic
3. **Keep versions in sync** - Use the Version Bump workflow
4. **Test locally first** - Run `docker build` before pushing
5. **Fill out PR templates** - Helps reviewers understand changes
6. **Wait for checks** - Don't merge until all automated checks pass
7. **Semantic versioning** - Choose appropriate version bump type

## Support

- **Issues:** https://github.com/N85UK/UNRAID_Apps/issues
- **Discussions:** https://github.com/N85UK/UNRAID_Apps/discussions
- **Documentation:** See CONTRIBUTING.md

---

**Happy Shipping! üöÄ**
